import React, { useCallback, useContext, useState } from 'react';
import { ActivityIndicator, ScrollView, View } from 'react-native';
import CWText from '../../components/CWText';
import DashboardLineChart from './DashboardLineChart';
import DashboardProfile from './DashboardProfile';
import EncryptedStorage from 'react-native-encrypted-storage';
import DashboardProfitDetailScreen from './DashboardProfitDetailScreen';
import { priceHistoriesURL, BASE_URL } from '../../configs/apiConfig';
import axios from 'axios';
import { ONE } from '../../utils/enums';
import { useFocusEffect, useNavigation } from '@react-navigation/native';
import { CustomerContext } from '../../components/CustomerProvider';

const DashboardScreen = () => {
  const navigation = useNavigation();
  const { customerData } = useContext(CustomerContext);
  const [pointDetail, setPointDetail] = useState();
  const [chartData, setChartData] = useState({
    graphData: [],
    baseData: [],
    customer: customerData,
    balance: 0
  });
  const [isLoading, setIsLoading] = useState(true);
  const [isError, setIsError] = useState(false);
  const [errorMessage, setErrorMessage] = useState('');
  const getEndDate = () => {
    return new Date();
  };

  const getStartDate = () => {
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 6);
    return startDate;
  };

  const getCustomerBalance = (data) => {
    const IDR = 'IDR';
    const rupiahTicker = data.tickers.find((ticker) => ticker.ticker === IDR);
    return rupiahTicker?.amount;
  };

  const getTodayPortfolio = (portfolios) => {
    return portfolios.find((portfolio) => {
      return (
        new Date(portfolio.date).toLocaleDateString() ===
        new Date().toLocaleDateString()
      );
    });
  };

  const getTodayDetail = useCallback((graphData) => {
    setPointDetail({
      balance: graphData[graphData.length - ONE].balance,
      date: graphData[graphData.length - ONE].date,
      transactions: graphData[graphData.length - ONE].transactions
    });
  }, []);

  const fetchData = useCallback(async () => {
    const token = await EncryptedStorage.getItem('token');
    const headers = {
      Authorization: `Bearer ${token}`
    };

    try {
      setIsLoading(true);
      setIsError(false);
      const startDate = getStartDate();
      const endDate = getEndDate();

      const { data: portfolios } = await axios.get(
        `${BASE_URL}/customers/${
          customerData.id
        }/portfolio-histories?date_from=${startDate.toLocaleDateString()}&date_to=${endDate.toLocaleDateString()}`,
        { headers }
      );

      console.log('portfolios', portfolios);
      const { data: priceHistories } = await axios.get(
        `${priceHistoriesURL}?date_from=${startDate.toLocaleDateString()}&date_to=${endDate.toLocaleDateString()}`,
        { headers }
      );
      console.log('priceHistoru', priceHistories);
      const { data: transactions } = await axios.get(
        `${BASE_URL}/customers/${customerData.id}/transactions`,
        {
          headers
        }
      );
      console.log('transactions', transactions);

      const apiData = {
        portfolios: portfolios.portfolios,
        priceHistories: priceHistories.priceHistories,
        transactions: transactions.transactions
      };
      const graphData = getGraphData(apiData);
      getTodayDetail(graphData);
      const baseData = getBaseData(graphData);
      const customerBalance = getCustomerBalance(
        getTodayPortfolio(apiData.portfolios)
      );
      setChartData((data) => ({
        ...data,
        graphData: graphData,
        baseData: baseData,
        customer: customerData,
        balance: customerBalance
      }));
    } catch (error) {
      console.log('error', error);
      if (error?.response?.data?.message === 'Invalid Token') {
        await EncryptedStorage.removeItem('token');
        navigation.replace('Login');
      }
      setErrorMessage('Oops, something wrong!');
      setIsError(true);
    } finally {
      setIsLoading(false);
    }
  }, [getGraphData, getTodayDetail, getBaseData, customerData, navigation]);

  useFocusEffect(
    useCallback(() => {
      fetchData();
    }, [fetchData])
  );

  const getGraphBalance = (portfolio, priceHistories, portfolioDate) => {
    return portfolio.tickers
      .map((ticker) => {
        const price = priceHistories.find((priceHistory) => {
          const priceDate = new Date(priceHistory.date).toLocaleDateString();
          return (
            portfolioDate === priceDate &&
            priceHistory.ticker.ticker === ticker.ticker
          );
        });
        return price?.price ? ticker.amount * price?.price : ticker.amount;
      })
      .reduce((total, tickerPrice) => total + tickerPrice, 0);
  };

  const getDate = (portfolio) => {
    return new Date(portfolio.date).toLocaleDateString('id-ID', {
      day: '2-digit',
      month: 'short',
      year: 'numeric'
    });
  };

  const getTransactions = (transactions, portfolioDate) => {
    return transactions.filter((transaction) => {
      const transactionDate = new Date(transaction.date).toLocaleDateString();
      return transactionDate === portfolioDate;
    });
  };

  const getGraphData = useCallback((data) => {
    const { priceHistories, portfolios, transactions } = data;
    return portfolios.map((portfolio) => {
      const portfolioDate = new Date(portfolio.date).toLocaleDateString();
      return {
        balance: getGraphBalance(portfolio, priceHistories, portfolioDate),
        date: getDate(portfolio),
        transactions: getTransactions(transactions, portfolioDate)
      };
    });
  }, []);

  const getBaseData = useCallback((data) => {
    const newBaseData = [];

    data.map((item, index) => {
      newBaseData.push({
        ...item,
        balance: data[0].balance,
        date: data[index].date
      });
    });

    return newBaseData;
  }, []);

  const handleProfitDetailClick = (dataPoint) => {
    dataPoint.map((point) => {
      setPointDetail({
        balance: point.balance,
        date: point.date,
        transactions: point.transactions
      });
    });
  };

  if (isLoading) {
    return (
      <View className="flex-1 justify-center items-center bg-cw-lightpurple">
        <ActivityIndicator
          accessibilityLabel="loader-activity"
          size="large"
          color="blue"
        />
      </View>
    );
  }

  if (errorMessage && isError) {
    return (
      <View
        accessibilityLabel="error"
        className="flex-1 justify-center items-center bg-cw-lightpurple">
        <CWText className="text-2xl text-center">{errorMessage}</CWText>
      </View>
    );
  }
  return (
    <ScrollView className="flex-1 min-w-full bg-cw-lightgrey">
      <View className="flex-1 h-full" accessibilityLabel="Dashboard">
        {chartData.graphData.length > 0 && (
          <View>
            <View className="px-6 justify-center flex-col">
              <DashboardProfile
                customerData={chartData.customer}
                balance={chartData.balance}
              />
            </View>
            <View accessibilityLabel="profit loss line chart">
              <DashboardLineChart
                data={chartData.graphData}
                baseData={chartData.baseData}
                handleProfitDetailClick={handleProfitDetailClick}
              />
            </View>
            {pointDetail && (
              <DashboardProfitDetailScreen pointDetail={pointDetail} />
            )}
          </View>
        )}
      </View>
    </ScrollView>
  );
};

export default DashboardScreen;
